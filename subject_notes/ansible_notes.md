# Configuration Management: Ansible

## What is Ansible?

Ansible is a configuration management tool. It allows system administrators to define tasks and settings to be applied or run on a system, instead of configuring it manually.

Ansible has a different approach from other configuration management tools. It only requires Python to be installed, and does NOT require any extra software on the target servers. On Linux servers, Ansible works by opening an SSH connection to the target host. The two requirements for Ansible to work on a target is:

1. have Python installed
2. have a way to connect to the target from the Ansible host (usually SSH)

A very important aspect of Ansible is that it achieves **idempotence**: a command always achieve the same result, whether it is run once or a thousand times. This is important for configuration management, where we want to define the **status** of a machine, or service.

## Ansible concepts

### Control node

A system on which Ansible is installed. You run Ansible commands such as `ansible` or `ansible-inventory` on a control node. Your WSL instance will be the control note.

### Managed node

A remote system, or host, that Ansible controls. An individual server managed by ansible. Your EC2 instances will be the managed node for this course.

### Inventory

The inventory is a collection of "hosts" (machines or artifacts) that can be provisioned using Ansible. It can be defined statically (the inventory is a file), or generated by a program dynamically.

In a static inventory, hosts can be specified by DNS name, ssh alias, or IP address. The inventory can be in INI format, or in YAML format.

Example inventory file (INI format):

    [webservice]
    httpsrv
    dbsrv
    appsrv

This defines a group called _webservice_, which has 3 hosts: _httpsrv_, _dbsrv_ and _appsrv_.

For more information, see [the documentation](https://docs.ansible.com/ansible/latest/user_guide/intro_inventory.html).

### Modules

An Ansible module is a piece of code that executes a specific provisioning task on a managed host. Some examples of _core_ Ansible modules:

- `file`: to provision a file
- `shell`: to run a shell command (either with a script, or inline)
- `get_url`: to download a file
- `package`: to work with the package manager from the OS

Ansible modules are divided into core modules (included in Ansible) and community modules (available as a separate package).

#### Finding help about modules

Ansible includes the `ansible-doc` command. Which is a little like man pages for Ansible. You can see the docs for a module by running `ansible-doc package` for example. To search for a module, you can use our old friend grep:

`ansible-doc -l | grep ^package`

### Playbooks

Playbooks are the files that define how Ansible modules should be applied to the hosts in the inventory. They are written using Ansible "grammar" in YAML, and are meant to be human-readable (text format).

#### Validating your Ansible playbooks

A helpful tool when working with YAML files is `yamllint` which is available in most package repositories.

Ansible also includes a few commands that can be used to validate your ansible playbooks.

```bash
$ ansible-playbook --syntax-check webservers.yml
$ ansible-lint webservers.yml
```

### If Ansible modules are the tools in your workshop, playbooks are your instruction manuals, and your inventory of hosts are your raw material.

See the official [documentation](https://docs.ansible.com/ansible/latest/user_guide/playbooks.html) for more details.

## Variables

Ansible playbooks can also contain variables. Like most variables if you need to set a value used in multiple locations in your playbook it is a good idea to create a variable.

Variables can be defined in your inventory, playbook, or in separate variables files

```yml
---
- hosts: all
  remote_user: root
  vars:
    favcolor: blue
  vars_files:
    - /vars/external_vars.yml

  tasks:
    - name: This is just a placeholder
      ansible.builtin.command: /bin/echo foo
```

variables are referenced with Jinja2 syntax

```yml
dest: "{{ remote_install_path }}/foo.cfg"
```

Note on quoting variables. When you use a variable that contains additional scalar values, like the example above, you need to wrap the entire value in quotes.

We will look at variables in more detail when we create more complex playbooks latter.

## Ansible Resources

### Introductory Ansible References 

1. [Chapter 1 Ansible Introduction (Ansible: Up and Running, 3rd Edition)](https://learning.oreilly.com/library/view/ansible-up-and/9781098109141/ch01.html)
1. [Chapter 3 Ansible Playbooks (Ansible: Up and Running, 3rd Edition)](https://learning.oreilly.com/library/view/ansible-up-and/9781098109141/ch03.html)
1. [Chapter 4 Ansible Inventory (Ansible: Up and Running, 3rd Edition)](https://learning.oreilly.com/library/view/ansible-up-and/9781098109141/ch04.html)

### Example Playbooks

1. [Simple Playbook Examples](https://www.middlewareinventory.com/blog/ansible-playbook-example/)
1. [Full Playbook Examples](https://github.com/ansible/ansible-examples) - These are role based that we will cover later in the course.

### Configuration Management Modules References

- Wait till remote is ready: [`wait_for_connection`](https://docs.ansible.com/ansible/latest/collections/ansible/builtin/wait_for_connection_module.html)
- Install packages (General): [`package`](https://docs.ansible.com/ansible/latest/collections/ansible/builtin/package_module.html)
- Install packages (Ubuntu): [`apt`](https://docs.ansible.com/ansible/latest/collections/ansible/builtin/apt_module.html)
- Manage users: [`user`](https://docs.ansible.com/ansible/latest/collections/ansible/builtin/user_module.html)
- Manage file and properties/permissions: [`file`](https://docs.ansible.com/ansible/latest/collections/ansible/builtin/file_module.html)
- Copy to remote: [`copy`](https://docs.ansible.com/ansible/latest/collections/ansible/builtin/copy_module.html)
- Template out to remote: [`template`](https://docs.ansible.com/ansible/latest/collections/ansible/builtin/template_module.html)
- Download a file: [`get_url`](https://docs.ansible.com/ansible/latest/collections/ansible/builtin/get_url_module.html)
- Unzip a file: [`unarchive`](https://docs.ansible.com/ansible/latest/collections/ansible/builtin/unarchive_module.html)
  - Use `remote_src: yes` only if the compressed file is already on the remote target!
  - Make sure the binaries to uncompress your file are installed (for example `unzip`)
- Manage systemd units: [`systemd`](https://docs.ansible.com/ansible/latest/collections/ansible/builtin/systemd_module.html)
- Manage Python dependencies: [`pip`](https://docs.ansible.com/ansible/latest/collections/ansible/builtin/pip_module.html)
- Manage MySQL users: [`mysql_user`](https://docs.ansible.com/ansible/latest/collections/community/mysql/mysql_user_module.html)
- Manage MySQL databases: [`mysql_db`](https://docs.ansible.com/ansible/latest/collections/community/mysql/mysql_db_module.html)
- Get file/filesystem status: [`stat`](https://docs.ansible.com/ansible/latest/collections/ansible/builtin/stat_module.html)
- Print variables / messages: [`debug`](https://docs.ansible.com/ansible/latest/collections/ansible/builtin/debug_module.html)
- Run a shell command (**AS A LAST RESORT!**): [`shell`](https://docs.ansible.com/ansible/latest/collections/ansible/builtin/shell_module.html)

> Make sure you look at the requirements for each module! The MySQL modules will require Python libraries for mysql. You can install them first with `apt`.

### Ansible Logic References

- [`register`](https://docs.ansible.com/ansible/latest/user_guide/playbooks_variables.html#registering-variables): saves the output of a module in a variable
- [`when`](https://docs.ansible.com/ansible/latest/user_guide/playbooks_conditionals.html): conditionally runs a task
- [Loops](https://docs.ansible.com/ansible/latest/user_guide/playbooks_loops.html): repeat tasks with different parameters
- [`become` and `become_user`](https://docs.ansible.com/ansible/latest/user_guide/become.html): run tasks as a different user
